{"version":3,"sources":["../lib/zhipu-ai.ts","../lib/jwt.ts","../lib/completions.ts"],"sourcesContent":["import assert from \"assert\"\nimport { generateToken } from \"./jwt.js\"\nimport Axios, { AxiosInstance, AxiosRequestConfig, AxiosResponse } from \"axios\"\nimport Completions, { CreateCompletionsOptions } from \"./completions.js\"\n\nexport type ZhipuAIOptions = {\n    apiKey: string,\n    baseUrl?: string,\n    timeout?: number,\n    maxRetries?: number,\n    customHeaders?: object\n}\n\nexport class ZhipuAI {\n    public __esModule = false\n    public request: AxiosInstance\n\n    constructor(private readonly options: ZhipuAIOptions) {\n        if (!options.apiKey) options.apiKey = process.env['ZHIPUAI_API_KEY'] || ''\n        assert.ok(options.apiKey, \"未提供api_key，请通过参数或环境变量提供\")\n        if (!options.baseUrl) options.baseUrl = process.env[\"ZHIPUAI_BASE_URL\"] || ''\n        if (!options.baseUrl) options.baseUrl = \"https://open.bigmodel.cn/api/paas/v4\"\n        this.request = Axios.create({\n            baseURL: options.baseUrl,\n            timeout: options.timeout,\n            headers: options.customHeaders\n        })\n\n        this.request.interceptors.request.use((config) => {\n            config.headers.set(this.authHeaders())\n            return config;\n        })\n    }\n\n    public async post(url: string, data?: object, config?: AxiosRequestConfig<object>): Promise<AxiosResponse<any>> {\n        return this.request.post(url, data, config)\n    }\n\n    public async createCompletions(options: CreateCompletionsOptions): Promise<AxiosResponse<any>> {\n        return new Completions(this).create(options)\n    }\n\n    authHeaders() {\n        const token = generateToken(this.options.apiKey)\n        return { \"Authorization\": token }\n    }\n}\n\nexport default ZhipuAI","import jsonwebtoken from \"jsonwebtoken\"\n\n\nconst API_TOKEN_TTL_SECONDS = 3 * 60\n\n// const CACHE_TTL_SECONDS = API_TOKEN_TTL_SECONDS - 30\n\nexport const generateToken = (apiKey: string) => {\n    try {\n        const [api_key, secret] = apiKey.split(\".\")\n        const payload = {\n            \"api_key\": api_key,\n            \"exp\": Math.round(Date.now() * 1000) + API_TOKEN_TTL_SECONDS * 1000,\n            \"timestamp\": Math.round(Date.now() * 1000),\n        }\n        // algorithm = \"HS256\", headers = { \"alg\": \"HS256\", \"sign_type\": \"SIGN\" }\n        //@ts-ignore 不用管\n        const ret = jsonwebtoken.sign(payload, secret, {\n            algorithm: \"HS256\",\n            header: { alg: \"HS256\", sign_type: \"SIGN\" }\n        })\n        return ret\n    } catch (e) {\n        throw \"invalid api_key\"\n    }\n}","import { AxiosResponse } from \"axios\";\nimport ZhipuAI from \"./zhipu-ai.js\";\n\nexport type MessageOptions = {\n    role: \"system\" | \"user\" | \"assistant\" | \"function\"\n    content: string\n}\n\nexport type CreateCompletionsOptions = {\n    model: string,\n    messages: Array<MessageOptions>,\n    request_id?: string,\n    do_sample?: boolean,\n    stream?: boolean,\n    temperature?: number,\n    top_p?: number,\n    max_tokens?: number,\n    seed?: number,\n    stop?: Array<string>,\n    sensitive_word_check?: object,\n    tools?: object,\n    tool_choice?: string,\n    extra_headers?: object,\n    disable_strict_validation?: boolean,\n    timeout?: number,\n}\n\nexport type ResponseMessage = {\n    id: string,\n    created: number,\n    model: string,\n    choices: Array<{\n        index: number,\n        finish_reason: string,\n        message: {\n            role: string,\n            content: string,\n            tool_calls: Array<{\n                id: string,\n                type: string,\n                function: {\n                    name: string,\n                    arguments: object,\n                }\n            }>\n        },\n        delta: {\n            role: string,\n            content: string,\n            tool_calls: Array<{\n                id: string,\n                type: string,\n                function: {\n                    name: string,\n                    arguments: object,\n                }\n            }>\n        }\n    }>,\n    usage: {\n        prompt_tokens: number,\n        completion_tokens: number,\n        total_tokens: number,\n    },\n}\n\nexport default class Completions {\n    constructor(private readonly app: ZhipuAI) {\n    }\n\n    public async create(options: CreateCompletionsOptions): Promise<AxiosResponse<ResponseMessage>> {\n        return this.app.post(\"/chat/completions\", {\n            \"model\": options.model,\n            \"request_id\": options.request_id,\n            \"temperature\": options.temperature,\n            \"top_p\": options.top_p,\n            \"do_sample\": options.do_sample,\n            \"max_tokens\": options.max_tokens,\n            \"seed\": options.seed,\n            \"messages\": options.messages,\n            \"stop\": options.stop,\n            \"sensitive_word_check\": options.sensitive_word_check,\n            \"stream\": options.stream,\n            \"tools\": options.tools,\n            \"tool_choice\": options.tool_choice,\n        }, {\n            headers: options.extra_headers,\n            responseType: options.stream ? 'stream' : 'json'\n        })\n    }\n} "],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,oBAAmB;;;ACAnB,0BAAyB;AAGzB,IAAM,wBAAwB,IAAI;AAI3B,IAAM,gBAAgB,CAAC,WAAmB;AAC7C,MAAI;AACA,UAAM,CAAC,SAAS,MAAM,IAAI,OAAO,MAAM,GAAG;AAC1C,UAAM,UAAU;AAAA,MACZ,WAAW;AAAA,MACX,OAAO,KAAK,MAAM,KAAK,IAAI,IAAI,GAAI,IAAI,wBAAwB;AAAA,MAC/D,aAAa,KAAK,MAAM,KAAK,IAAI,IAAI,GAAI;AAAA,IAC7C;AAGA,UAAM,MAAM,oBAAAA,QAAa,KAAK,SAAS,QAAQ;AAAA,MAC3C,WAAW;AAAA,MACX,QAAQ,EAAE,KAAK,SAAS,WAAW,OAAO;AAAA,IAC9C,CAAC;AACD,WAAO;AAAA,EACX,SAAS,GAAG;AACR,UAAM;AAAA,EACV;AACJ;;;ADvBA,mBAAwE;;;AEgExE,IAAqB,cAArB,MAAiC;AAAA,EAC7B,YAA6B,KAAc;AAAd;AAAA,EAC7B;AAAA,EAEa,OAAO,SAA4E;AAAA;AAC5F,aAAO,KAAK,IAAI,KAAK,qBAAqB;AAAA,QACtC,SAAS,QAAQ;AAAA,QACjB,cAAc,QAAQ;AAAA,QACtB,eAAe,QAAQ;AAAA,QACvB,SAAS,QAAQ;AAAA,QACjB,aAAa,QAAQ;AAAA,QACrB,cAAc,QAAQ;AAAA,QACtB,QAAQ,QAAQ;AAAA,QAChB,YAAY,QAAQ;AAAA,QACpB,QAAQ,QAAQ;AAAA,QAChB,wBAAwB,QAAQ;AAAA,QAChC,UAAU,QAAQ;AAAA,QAClB,SAAS,QAAQ;AAAA,QACjB,eAAe,QAAQ;AAAA,MAC3B,GAAG;AAAA,QACC,SAAS,QAAQ;AAAA,QACjB,cAAc,QAAQ,SAAS,WAAW;AAAA,MAC9C,CAAC;AAAA,IACL;AAAA;AACJ;;;AF7EO,IAAM,UAAN,MAAc;AAAA,EAIjB,YAA6B,SAAyB;AAAzB;AAH7B,wBAAO,cAAa;AACpB,wBAAO;AAGH,QAAI,CAAC,QAAQ;AAAQ,cAAQ,SAAS,QAAQ,IAAI,iBAAiB,KAAK;AACxE,kBAAAC,QAAO,GAAG,QAAQ,QAAQ,yGAAyB;AACnD,QAAI,CAAC,QAAQ;AAAS,cAAQ,UAAU,QAAQ,IAAI,kBAAkB,KAAK;AAC3E,QAAI,CAAC,QAAQ;AAAS,cAAQ,UAAU;AACxC,SAAK,UAAU,aAAAC,QAAM,OAAO;AAAA,MACxB,SAAS,QAAQ;AAAA,MACjB,SAAS,QAAQ;AAAA,MACjB,SAAS,QAAQ;AAAA,IACrB,CAAC;AAED,SAAK,QAAQ,aAAa,QAAQ,IAAI,CAAC,WAAW;AAC9C,aAAO,QAAQ,IAAI,KAAK,YAAY,CAAC;AACrC,aAAO;AAAA,IACX,CAAC;AAAA,EACL;AAAA,EAEa,KAAK,KAAa,MAAe,QAAkE;AAAA;AAC5G,aAAO,KAAK,QAAQ,KAAK,KAAK,MAAM,MAAM;AAAA,IAC9C;AAAA;AAAA,EAEa,kBAAkB,SAAgE;AAAA;AAC3F,aAAO,IAAI,YAAY,IAAI,EAAE,OAAO,OAAO;AAAA,IAC/C;AAAA;AAAA,EAEA,cAAc;AACV,UAAM,QAAQ,cAAc,KAAK,QAAQ,MAAM;AAC/C,WAAO,EAAE,iBAAiB,MAAM;AAAA,EACpC;AACJ;AAEA,IAAO,mBAAQ;","names":["jsonwebtoken","assert","Axios"]}